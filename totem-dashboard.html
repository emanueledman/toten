<!-- totem-dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Totem Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 9999;
        }
    </style>
</head>
<body class="bg-gray-100">
   
    <header class="bg-indigo-600 text-white p-4 flex justify-between items-center">
        <h1 class="text-xl font-bold">Totem Dashboard - <span id="branch-name">Carregando...</span></h1>
        <button id="logout" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-md">Sair</button>
    </header>
    <main class="p-8">
        <p class="text-lg">Bem-vindo ao dashboard do totem. Aqui você pode listar serviços e gerar tickets.</p>
        <div id="services-container" class="mt-6">
            <h2 class="text-xl font-semibold mb-4">Serviços Disponíveis</h2>
            <div id="services-list" class="grid grid-cols-1 gap-4">
                <!-- Serviços serão inseridos aqui dinamicamente -->
            </div>
        </div>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="central.js"></script>
    <script src="totem-auth-service.js"></script>
    <script>
        async function loadServices() {
            showLoading(true);
            try {
                const totemInfo = totemAuthService.getTotemInfo();
                const branchId = totemInfo.branchId;

                if (!branchId) {
                    console.error("Branch ID não encontrado.");
                    showMessage("Erro: Filial não identificada.", "error");
                    return;
                }

                const response = await axios.get(`${API_BASE}/api/totem/branches/${branchId}/services`);
                const data = response.data;

                if (data.categories && data.categories.length > 0) {
                    const servicesList = document.getElementById('services-list');
                    servicesList.innerHTML = ''; // Limpar lista existente

                    data.categories.forEach(category => {
                        const categoryDiv = document.createElement('div');
                        categoryDiv.className = 'mb-4';
                        categoryDiv.innerHTML = `<h3 class="text-lg font-medium">${category.category_name}</h3>`;

                        category.services.forEach(service => {
                            const serviceButton = document.createElement('button');
                            serviceButton.className = 'w-full bg-indigo-500 text-white py-2 px-4 rounded-md hover:bg-indigo-600 mb-2';
                            serviceButton.innerText = `${service.service_name} (Espera: ${service.estimated_wait_time})`;
                            serviceButton.addEventListener('click', () => generateTicket(branchId, service.service_id));
                            categoryDiv.appendChild(serviceButton);
                        });

                        servicesList.appendChild(categoryDiv);
                    });
                } else {
                    showMessage("Nenhum serviço disponível no momento.", "info");
                }
            } catch (error) {
                console.error("Erro ao carregar serviços:", error);
                showMessage("Erro ao carregar serviços. Tente novamente.", "error");
            } finally {
                showLoading(false);
            }
        }

        async function generateTicket(branchId, serviceId) {
            showLoading(true);
            try {
                const response = await axios.post(`${API_BASE}/api/totem/branches/${branchId}/services/${serviceId}/ticket`);
                // O servidor retorna um PDF, que pode ser tratado como um download
                const blob = new Blob([response.data], { type: 'application/pdf' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `ticket_${serviceId}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);

                showMessage("Ticket gerado com sucesso!", "success");
            } catch (error) {
                console.error("Erro ao gerar ticket:", error);
                showMessage("Erro ao gerar ticket. Tente novamente.", "error");
            } finally {
                showLoading(false);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.info("Inicializando página do totem...");

            // Verificar autenticação
            if (!totemAuthService.checkAuthAndRedirect()) {
                console.warn("Verificação de autenticação falhou");
                return;
            }

            // Configurar informações do totem na UI
            totemAuthService.setTotemInfoUI();

            // Carregar serviços
            loadServices();

            // Configurar botão de logout
            const logoutBtn = document.getElementById('logout');
            if (logoutBtn) {
                console.debug("Botão de logout encontrado, configurando handler");
                logoutBtn.addEventListener('click', () => {
                    console.info("Logout do totem iniciado pelo usuário");
                    totemAuthService.logout();
                });
            }

            console.info("Página do totem carregada com sucesso");
        });
    </script>
</body>
</html>